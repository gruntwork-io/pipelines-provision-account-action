name: Bootstrap a new account in access-control repo
description: "Sets up a new AWS account and basic roles inside the access control repo"
inputs:
  gruntwork_code_access_token:
    description: ""
    required: true
  gruntwork_context:
    description: "Gruntwork Context From the Gruntwork Bootstrap step"
    required: true

runs:
  using: composite
  steps:
    # - name: "[ProvisionAccount]: Setup access-control PR"
    #   id: provision_access_control
    #   uses: gruntwork-io-team/pipelines-setup-access-control@main
    #   with:
    #     new_account_name: ${{ inputs.new_account_name }}

    - name: "[ProvisionAccount]: Load Gruntwork Context"
      id: gruntwork_context
      uses: gruntwork-io-team/pipelines-bootstrap@main
      # Only try this if we've actually created the account
      with:
        cache: ${{ inputs.gruntwork_context }}
        token: ${{ inputs.gruntwork_code_access_token }}

    - name: "[ProvisionAccount]: Run Terragrunt to Create the account in AWS"
      id: terragrunt
      uses: gruntwork-io-team/pipelines-aws-execute@main
      with:
        gruntwork_code_access_token: ${{ inputs.gruntwork_code_access_token }}
        terragrunt_command: ${{ steps.gruntwork_context.outputs.terragrunt_command }}
        account_id: ${{ steps.gruntwork_context.outputs.account_id }}
        aws_region: ${{ steps.gruntwork_context.outputs.aws_region }}
        branch: ${{ steps.gruntwork_context.outputs.branch }}
        working_directory: ${{ steps.gruntwork_context.outputs.working_directory }}
        account_role_name: ${{ steps.gruntwork_context.outputs.role_name }}
        role_session_name: ${{ steps.gruntwork_context.outputs.role_session_name }}
        chain_account_id: ${{ steps.gruntwork_context.outputs.child_account_id }}
        chain_account_role_name: ${{ steps.gruntwork_context.outputs.child_acct_role_name }}
        terraform_version: ${{ steps.gruntwork_context.outputs.terraform_version }}
        terragrunt_version: ${{ steps.gruntwork_context.outputs.terragrunt_version }}
        gruntwork_config_file: ${{ steps.gruntwork_context.outputs.gruntwork_config_file }}
        pipelines_cli_version: ${{ steps.gruntwork_context.outputs.pipelines_cli_version }}


    - name: "[ProvisionAccount]: Get requesting PR number"
      id: get_pr_number
      shell: bash
      if:  ${{ steps.gruntwork_context.outputs.terragrunt_command == 'apply' }}
      env:
        COMMIT_SHA: ${{ steps.gruntwork_context.outputs.branch }}
        GH_TOKEN: ${{ inputs.gruntwork_code_access_token }}
        REPO: ${{ github.repository }}
      run: |
        PR_NUMBER=$(gh -R "$REPO" pr list --search "$COMMIT_SHA" --state merged --json number -q '.[0].number')
        echo "The PR number is: $PR_NUMBER"
        echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

    - name: "[ProvisionAccount]: Check out terraform-aws-control-tower repo"
      if: ${{ steps.gruntwork_context.outputs.terragrunt_command == 'apply' }}
      uses: actions/checkout@v4
      with:
        repository: gruntwork-io/terraform-aws-control-tower
        token: ${{ inputs.gruntwork_code_access_token }}
        path: terraform-aws-control-tower
        ref: ${{ env.CONTROL_TOWER_MODULES_VERSION }}

    - name: "[ProvisionAccount]: Install boilerplate"
      if:  ${{ steps.gruntwork_context.outputs.terragrunt_command == 'apply' }}
      shell: bash
      env:
        GITHUB_OAUTH_TOKEN: ${{ inputs.gruntwork_code_access_token }}
      run: |
        curl -Ls https://raw.githubusercontent.com/gruntwork-io/gruntwork-installer/main/bootstrap-gruntwork-installer.sh | bash /dev/stdin --version "$GRUNTWORK_INSTALLER_VERSION"
        gruntwork-install --binary-name boilerplate --repo https://github.com/gruntwork-io/boilerplate --tag "$BOILERPLATE_VERSION"

    - name: "[ProvisionAccount]: Run boilerplate to generate code"
      if:  ${{ steps.gruntwork_context.outputs.terragrunt_command == 'apply' }}
      shell: bash
      env:
        ACCOUNT_NAME: ${{ steps.gruntwork_context.outputs.new_account_name }}
        AWS_REGION: ${{ steps.gruntwork_context.outputs.aws_region }}
        ORG_NAME_PREFIX: ${{ steps.gruntwork_context.outputs.org_name_prefix }}
        ACCOUNT_BASELINE_MODULES_VERSION: ${{ steps.gruntwork_context.outputs.account_baseline_modules_version }}
        ACCOUNT_BASELINE_CIS_SERVICE_CATALOG_VERSION: ${{ steps.gruntwork_context.outputs.account_baseline_cis_service_catalog_version }}
        REQUESTING_TEAM_NAME: ${{ steps.gruntwork_context.outputs.requesting_team_name }}
        DEFAULT_TAGS: ${{ steps.gruntwork_context.outputs.default_tags }}
        CREATE_VPC: ${{ steps.gruntwork_context.outputs.create_vpc  }}
      run: |
        boilerplate \
          --template-url "./terraform-aws-control-tower//templates/landingzone/boilerplate-single-account-baseline" \
          --output-folder . \
          --var AccountName="$ACCOUNT_NAME" \
          --var AwsRegion="$AWS_REGION" \
          --var OrgNamePrefix="$ORG_NAME_PREFIX" \
          --var AccountBaselineModulesVersion="$ACCOUNT_BASELINE_MODULES_VERSION" \
          --var AccountBaselineCISServiceCatalogVersion="$ACCOUNT_BASELINE_CIS_SERVICE_CATALOG_VERSION" \
          --var RequestingTeamName="$REQUESTING_TEAM_NAME" \
          --var DefaultTags="$DEFAULT_TAGS" \
          --var CreateVPC="$CREATE_VPC" \
          --var VpcModuleVersion="$ACCOUNT_BASELINE_CIS_SERVICE_CATALOG_VERSION" \
          --non-interactive

    - name: "[ProvisionAccount]: Remove Control Tower Repo"
      shell: bash
      if:  ${{ steps.gruntwork_context.outputs.terragrunt_command == 'apply' }}
      run: rm -rf terraform-aws-control-tower

    - name: "[ProvisionAccount]: Create Pull Request"
      if:  ${{ steps.gruntwork_context.outputs.terragrunt_command == 'apply' }}
      id: create_pr
      uses: peter-evans/create-pull-request@v6
      with:
        base: main
        token: ${{ inputs.gruntwork_code_access_token }}
        branch: "enhancement/baseline-account-${{ steps.gruntwork_context.outputs.new_account_name }}"
        commit-message: "Generate account baseline for: ${{ steps.gruntwork_context.outputs.new_account_name }}"
        title: "Generate account baseline for: ${{ steps.gruntwork_context.outputs.new_account_name }}"
        body: |
          This pull request applies an account baseline to the **${{ steps.gruntwork_context.outputs.new_account_name }}** AWS account, which was created in https://github.com/${{ github.repository }}/pull/${{ steps.get_pr_number.outputs.pr_number }} using Gruntwork Landing Zone. To **apply** this baseline, do the following:

            1. Inspect the details in this pull request and confirm correctness.
            2. Merge this pull request.

          Once merged, Gruntwork Pipelines will `terragrunt apply` the baseline in the newly created AWS account.
